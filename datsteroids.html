<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
 
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
		
		<title>D3DATSTEROIDS</title>
	
	<script type="text/javascript" src="d3/d3.v3.js"></script>
	
	<script type="text/javascript" src="js/datsteroids.js"></script>
	
	<link type="text/css" href="css/datsteroids.css" rel="stylesheet"/>
	
	</head>
	
	<body>
		<div id="fps">FPS: <span>?</span></div>
		<script type="text/javascript">
			

	//
	//Functions//
	//
	//
		
	
	//Gets random Int or Float in a range of values. 
	//Zerovalue will substitute zero when it appears. This is so it doesn't mess my velocities later. Don't
	//want static objects around.
	
	var getRandomNum = function(min, max, zerovalue, isInt) {
    	var value = 0;
    	
    	if(isInt) value = Math.floor(Math.random() * (max - min + 1)) + min;
    	else value = Math.random() * (max - min ) + min;
    	
    	if(value == 0) value = zerovalue;
    	
    	return value;
	}
		
	//Generates a random array that represents the data on the Rocks
		
	var generateDataset = function(number)
	{
		var dataArray = [];
		var dataObject = new Object();
		
			for(var i=0; i<number; i++)
			{
				dataObject = {
					
					key: indexRocks,
					x: getRandomNum(0,width,0,true),
					y: getRandomNum(0,height,0,true),
					size: getRandomNum(30,75,0,true),
					xvel: getRandomNum(-2,2,0.5,true),
					yvel: getRandomNum(-2,2,0.5,true),
					zvel: getRandomNum(-0.05,0.05,-0.01,false),
					name:"Unnamed"
					
				}
				
				indexRocks++;
				dataArray.push(dataObject);
			}
		
		return dataArray;
	
	}
	

////
///
// Starts the main program
///
////



			
// Set the dimensions of the canvas / graph

var	margin = {top: 5, right: 10, bottom: 10, left: 5},
	width = window.innerWidth - margin.left - margin.right,
	height = window.innerHeight - margin.top - margin.bottom
	numberRocks = 20,
	iterationTracker = 0,
	indexRocks = 0;


//Set the dataset

var dataset = generateDataset(1);
	
//Set the scales

var xScale = d3.scale.linear();
var yScale = d3.scale.linear();
var rScale = d3.scale.linear();


// Set the domains

var xDomain = xScale.domain([0,width]),
	yDomain = yScale.domain([0,height]);
	rDomain = rScale.domain([0,100]);
	
	
// Set the ranges

var	rangeX = xScale.range([0,width]),
	rangeY = yScale.range([height,0]);
	rangeR = rScale.range([0,50]);
	

//Create variables for frame tracking

var fps = d3.select("#fps span"),
	time0 = Date.now();
	time1 = 0;

// Create svg (canvas)
				

var canvas = d3.select("body")
			.append("svg")
			.attr("id","game_canvas")
			.attr("width", width)
			.attr("height", height);
	
			
				function gameLoop(){
					
					
					//Select circles
					
				var circles = canvas.selectAll("circle")
				   .data(dataset, function(d){ return d.key; });
				   
				   //Update circles
				   
				   circles.enter()
				   .append("circle")
				   .attr("cx", function(d) {
				   		return xScale(d.x);
				   })
				   .attr("cy", function(d) {
				   		return yScale(d.y);
				   })
				   .attr("r", function(d) {
				   		return rScale(d.size)
				   })
				   .attr("fill", function(d) {
				   	
				   		var radius = rScale(d.size);
				   		
				   		if(d.zvel > 0) return "black";
				   		else return "steelblue";
				   		
				   		//(130,188,255) Light blue
				   		//(117,0,0) Dark red
				   })
				   .transition()
				   .duration(function(d){
				   		return Math.abs(d.zvel)*100000;
				   })
				   .attr("fill", function(d) {
				   	
				   		var radius = rScale(d.size);
				   		
				   		if(d.zvel > 0) return "steelblue";
				   		else return "black";
				   		
				   		//(130,188,255) Light blue
				   		//(117,0,0) Dark red
				   });
				   
					
					
					//Remove circles without value
					
					circles.exit().remove();
					
					
					
					//Add a circle every X seconds
					
					if(iterationTracker == 0 || iterationTracker%100 == 0) addRock();
					
					//Move all rocks
										
					moveRocks(circles);
					
					//Paint frames
					time1 = Date.now();
					fps.text(Math.round(1000 / (time1 - time0)));
					time0 = time1;
					
					iterationTracker++;
					
						
				} setInterval(gameLoop,20);
			
				
				function addRock()
				{
										
										
					//Add rock to dataset
					
					dataset = dataset.concat(generateDataset(1));
					
					
				}
		
				function moveRocks(rocks)
				{
					dataset.forEach(function(d){
						
						d.x += d.xvel;
						d.y += d.yvel;
						d.size += d.zvel;
						
						if(d.size < 0) d.size = 0;
						
						//If rock is outside of the canvas we delete it from dataset
						
						if(d.x < 0-300 || d.x > width+300 || d.y < 0-300 || d.y > height+300)
						{
							dataset.splice(dataset.indexOf(d),1);
							
						}
						
					});
					
					rocks
					.attr("cx", function(d) {
				   		return xScale(d.x);
				   })
				   .attr("cy", function(d) {
				   		return yScale(d.y);
				   })
				   .attr("r", function(d) {
				   		return rScale(d.size)
				   });					
					
					
				}
		
		
	
			
		</script>
		
		
	</body>

</html>